<div class="card-bg">
    <h2 class="card-title text-center mt-0 mb-0">
        <b class="ng-binding">PHIẾU TRẢ LẠI HÀNG CHO NHÀ CUNG CẤP</b>
        <span ng-if="deviceType==0" style="padding-bottom: 12px; padding-left: 8px"
            class="btn tooltip-content-drug ng-scope">
            <span ng-click="">
                <i style="font-size:20px; color: black" class="fa fa-info-circle" aria-hidden="true"></i>
            </span>
            <span style="font-size:14px; text-transform:none" class="show-tooltip-content-drug">
                <b>F1:</b> Thêm mới phiếu trong tab mới<br>
                <b>F2:</b> Tìm khách hàng/nhà cung cấp<br>
                <b>F4:</b> Tính liều<br>
                <b>F8:</b> Thay đổi tổng tiền<br>
                <b>F9:</b> Ghi phiếu<br>
                <b>F11:</b> Toàn màn hình<br>
                <b>↑ và ↓:</b> Đi từ trên xuống<br>
            </span>
        </span>
    </h2>
    <form [formGroup]="formData">
        <div class="text-center card-desc">
            <div class="card-code">
                Mã số: <strong class="ng-binding">{{formData.value.soPhieuXuat}}</strong>
            </div>
            Ngày: <div class="clickable-text daterange-picker font-weight-bold"><input type="text" name="noteDate"
                    id="note-date-id" ng-model="noteDate" class="ng-pristine ng-untouched ng-valid"><span
                    class="text-link ng-binding">{{formData.value.NgayXuat}}</span> <span ng-if="viewModel.NoteId > 0"
                    class="ng-binding ng-scope">10:46</span></div>
        </div>
    
        <div class="mt-3">
            <table class="table borderless table-condensed" style="margin-bottom:0px;" ng-show="deviceType!=1">
                <tbody>
                    <tr>
                        <td class="w-50">
                            <div class="form-inline-flex">
                                <label>
                                    <span ng-if="viewModel.NoteTypeId==4" class="ng-scope">Nhà cung cấp:</span>
                                </label>
                                <div class="input-group ng-scope" ng-if="viewModel.NoteTypeId==4">
                                    <div item-search-filter="" select-changed-callback="onReceiverItemChanged"
                                        clear-after-selected="false" only-single-item="true"
                                        default-selected-item="receiverSelectedItem" show-cam-barcode-scanner="false"
                                        handle-broadcast="true" search-type="enableCustomerToSupplier ? 3 : 4"
                                        class="ip-position ip-min-width flex-grow-1  ng-isolate-scope"
                                        id="supplierSearchBoxId">
    
    
                                        <div class="control-group">
                                            <ng-select appendTo="body" formControlName="nhaCungCapMaNhaCungCap"
                                                appearance="outline" [items]="listNhaCungCaps" bindLabel="tenNhaCungCap"
                                                bindValue="id" placeholder="Tra cứu theo tên..."
                                                notFoundText="Không tìm thấy mục nào" refresh-delay="500"
                                                (search)="searchPageNhaCungCap($event)">
                                                <ng-template ng-option-tmp let-item="item" let-index="index"
                                                    let-search="searchTerm">
                                                    <span
                                                        [ngOptionHighlight]="search">{{item.tenNhaCungCap}}-{{item.soDienThoai}}-
                                                        {{item.diaChi}}</span>
                                                </ng-template>
                                            </ng-select>
                                        </div>
                                        <span id="Logo" style="display:none;"></span>
                                    </div>
                                    <div class="input-group-btn">
                                        <button class="btn btn-primary"
                                            ng-click="addSupplier(); $event.preventDefault(); $event.stopPropagation();"
                                            title="Thêm mới nếu chưa có">
                                            <i class="fa-regular fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
    
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
            <table mat-table class="table table-striped table-hover tr-ng-grid" [dataSource]="getDataSource()">
                <ng-container matColumnDef="#">
                    <th mat-header-cell *matHeaderCellDef style="width:5%"> #</th>
                    <td mat-cell *matCellDef="let data; index as i;" class="text-center">
                        <a *ngIf="data.thuocId == 0" class="btn btn-primary" title="Thêm mới"
                        ng-click="onAddNewItem(gridItem); $event.preventDefault(); $event.stopPropagation();"><i
                            class="fa-regular fa-plus"></i></a>
                            <a *ngIf="data.thuocId > 0" class="btn btn-danger" title="Thêm mới"
                            ng-click="onAddNewItem(gridItem); $event.preventDefault(); $event.stopPropagation();"><i
                                class="fa-regular fa-trash"></i></a>
                    </td>
                </ng-container>
                <ng-container matColumnDef="stt">
                    <th mat-header-cell *matHeaderCellDef style="width:5%"> STT</th>
                    <td mat-cell *matCellDef="let data; index as i;" class="text-center">
                        <span *ngIf="data.thuocId > 0" class="btn-link">{{ (page - 1) * pageSize + i
                            }}</span>
                    </td>
                </ng-container>
    
                <ng-container matColumnDef="anh">
                    <th mat-header-cell *matHeaderCellDef> Ảnh </th>
                    <td mat-cell *matCellDef="let data" class="text-right">
    
                    </td>
                </ng-container>
    
                <ng-container matColumnDef="matHang">
                    <th mat-header-cell *matHeaderCellDef style="width:30%">Mặt Hàng [Mã-Tên]</th>
                    <td mat-cell *matCellDef="let data">
                        <div *ngIf="data.thuocId == 0">
                            <div ng-if="!showCamBarcodeScanner" class="">
                                <div class="w-100">
                                    <div class="control-group">
                                        <ng-select appendTo="body" formControlName="nhaCungCapMaNhaCungCap"
                                            appearance="outline" [items]="listThuocs" bindLabel="tenThuoc" bindValue="id"
                                            placeholder="Tra cứu theo tên, mã, mã vạch..."
                                            notFoundText="Không tìm thấy mục nào" refresh-delay="500"
                                            (search)="searchPageDrug($event)"
                                            (change)="onDrugChange($event)">
                                            <ng-template ng-option-tmp let-item="item" let-index="index"
                                                let-search="searchTerm">
                                                <span [ngOptionHighlight]="search">{{item.maThuoc}}-{{item.tenThuoc}}-
                                                    {{item.tenDonViTinhXuatLe}} - Gián bán : {{item.giaBanLe
                                                    |number}}</span>
                                            </ng-template>
                                        </ng-select>
                                    </div>
                                </div>
                            </div>
                            <span id="Logo" style="display:none;"></span>
                        </div>
                        <span *ngIf="data.thuocId > 0">{{data.maThuoc}} - {{data.tenThuoc}}</span>
                    </td>
                </ng-container>
                <ng-container matColumnDef="donVi">
                    <th mat-header-cell *matHeaderCellDef style="width: 10%;"> Đơn vị</th>
                    <td mat-cell *matCellDef="let data">
                        <select class="form-control" [(ngModel)]="data.donViChon">
                            <option  *ngFor="let i of data.donViTinhs" value="{{i.maDonViTinh}}">
                                  {{i.tenDonViTinh}}
                            </option>
                        </select>
                    </td>
                </ng-container>
                <ng-container matColumnDef="soLuong">
                    <th mat-header-cell *matHeaderCellDef> Số lượng</th>
                    <td mat-cell *matCellDef="let data">
                        <input type="text" [(ngModel)]="data.soLuong" class="form-control text-right">
                    </td>
                </ng-container>
                <ng-container matColumnDef="donGia">
                    <th mat-header-cell *matHeaderCellDef width="10%">Đơn giá</th>
                    <td mat-cell *matCellDef="let data">
                        <input type="text" [(ngModel)]="data.giaBan" class="form-control text-right" />
                    </td>
                </ng-container>
                <ng-container matColumnDef="ck">
                    <th mat-header-cell *matHeaderCellDef> C.K(%)</th>
                    <td mat-cell *matCellDef="let data"> 
                        <input type="text" [(ngModel)]="data.ck" class="form-control text-right"/>
                        </td>
                </ng-container>
                <ng-container matColumnDef="vat">
                    <th mat-header-cell *matHeaderCellDef>VAT(%)</th>
                    <td mat-cell *matCellDef="let data">
                        <input type="text" [(ngModel)]="data.vat" class="form-control text-right"/>
                    </td>
                </ng-container>
                <ng-container matColumnDef="ton">
                    <th mat-header-cell *matHeaderCellDef>Tồn</th>
                    <td mat-cell *matCellDef="let data" class="text-center"> 
                        {{data.ton | number}}
                    </td>
                </ng-container>
                <ng-container matColumnDef="thanhTien">
                    <th mat-header-cell *matHeaderCellDef>Thành tiền</th>
                    <td mat-cell *matCellDef="let data" class="text-center">
                        {{(data.soLuong * data.giaBan ) | number}}
                    </td>
                </ng-container>
    
                <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    
            </table>
            <form class="form-inline ng-pristine ng-valid">
                <table class="borderless table-condensed">
                    <tbody>
                        <tr>
                            <td class="w-50">
                                <div class="d-flex gap-10 align-items-center justify-content-between">
                                    <div class="form-inline-flex flex-grow-1">
                                        <label>Tổng tiền:</label>
                                        <div class="flex-grow-1">
    
                                            <span ng-if="viewModel.NoteTypeId==2 || permittedFields.Drug_ViewInputPrice"
                                                class="ng-scope">
    
                                                <input id="txbTotalAmountId" type="text"
                                                    class="form-control mb-0 ng-pristine ng-untouched ng-valid ng-isolate-scope"
                                                    refresh-delay="500" ng-model="viewModel.TotalAmount"
                                                    awnum="app-int-number" ng-show="viewModel.AllowToChangeTotalAmount"
                                                    ng-keypress="onTotalAmountChanged($event)">
                                            </span>
                                        </div>
                                    </div>
                                    <div class="form-inline-flex flex-grow-1 ng-hide"
                                        ng-show="viewModel.NoteTypeId==2 &amp;&amp; viewModel.DiscountTotalByValue">
                                        <label>C.K.Đơn</label>
                                        <div class="input-group">
                                            <input type="text"
                                                class="form-control mb-0 ng-pristine ng-untouched ng-valid ng-isolate-scope"
                                                ng-model="viewModel.Discount" awnum="app-decimal-number"
                                                ng-change="onDiscountChanged(1)">
                                            <span style="padding: 5px 5px 5px 5px"
                                                class="input-group-addon flex-grow-width-auto">VNĐ</span>
                                        </div>
                                        <div class="input-group">
                                            <input style="max-width: 70px" type="text"
                                                class="form-control mb-0 ng-pristine ng-untouched ng-valid ng-isolate-scope"
                                                ng-model="discountWithRatio" awnum="app-decimal-number"
                                                ng-change="onDiscountChanged(2)">
                                            <span style="padding: 5px 5px 5px 5px"
                                                class="input-group-addon flex-grow-width-auto">%</span>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="w-50">
                                <div class="d-flex gap-10 align-items-center justify-content-between">
    
    
                                    <div ng-if="viewModel.NoteTypeId==2 || viewModel.NoteTypeId == 4"
                                        class="form-inline-flex flex-grow-1 ng-scope">
                                        <label>Trả: </label>
                                        <div class="input-group">
                                            <input ng-if="viewModel.NoteTypeId==2 || permittedFields.Drug_ViewInputPrice"
                                                type="text" id="tbxPaymentAmountTm"
                                                class="form-control mb-0 ng-pristine ng-untouched ng-valid ng-scope ng-isolate-scope"
                                                ng-model="viewModel.PaymentAmount" awnum="app-int-number">
    
                                            <input class="btn btn-primary btn-group" type="button" value="F"
                                                title="Ấn vào đây để trả đủ số tiền" id="btnFullTm"
                                                ng-click="onPayFullOption(false); $event.preventDefault(); $event.stopPropagation();">
                                        </div>
                                    </div>
                                </div>
    
                            </td>
                        </tr>
    
                        <tr ng-if="viewModel.NoteTypeId==2 || viewModel.NoteTypeId == 4" class="ng-scope">
                            <td class="w-50"></td>
                            <td class="">
                                <div class="d-flex gap-10">
                                    <div>
                                        <div class="msg_payment_header msg_payment_expanded">Hình thức thanh toán
                                            <span>[-]</span>
                                        </div>
                                        <div id="paymentSlide" class="form-check">
    
                                            <p style="margin: 5px 0 5px;" class="form-check-label ng-binding ng-scope"
                                                ng-repeat="item in listPayType">
                                                <input type="radio" class="form-check-input"
                                                    ng-checked="viewModel.OptionPay == item.Id" ng-click="changePay(item)"
                                                    name="optradio" checked="checked">Tiền mặt
                                            </p>
                                            <p style="margin: 5px 0 5px;" class="form-check-label ng-binding ng-scope"
                                                ng-repeat="item in listPayType">
                                                <input type="radio" class="form-check-input"
                                                    ng-checked="viewModel.OptionPay == item.Id" ng-click="changePay(item)"
                                                    name="optradio">Chuyển khoản
                                            </p>
                                        </div>
                                        <div>
                                            <span class="text-danger ng-binding ng-scope"
                                                ng-if="viewModel.NoteTypeId==2 || permittedFields.Drug_ViewInputPrice"><strong
                                                    class="ng-binding">Còn nợ:
                                                </strong>0</span>
    
                                        </div>
                                    </div>
    
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </form>
    
            <table class="table borderless table-condensed" style="padding: 5px">
                <tbody>
                    <tr ng-show="viewModel.DoctorId > 0" class="ng-hide">
                        <td>
                            <div class="d-flex gap-10 text-left">
                                <label>Bệnh theo chuẩn bộ y tế</label>
                                <div style="width: 100%">
                                    <div item-search-filter="" select-changed-callback="onDiagnosticItemChanged"
                                        clear-after-selected="true" only-single-item="true"
                                        default-selected-item="diagnosticSelectedItem" show-cam-barcode-scanner="false"
                                        handle-broadcast="true" search-type="9" class="ng-isolate-scope">
    
    
                                        <div ng-if="!showCamBarcodeScanner" class="">
                                            <div class="w-100">
                                                <div class="ui-select-container ui-select-multiple ui-select-bootstrap dropdown form-control ng-valid"
                                                    ng-class="{open: $select.open}" ng-model="data.selected"
                                                    theme="bootstrap" id="itemSearchId"
                                                    reset-search-input="clearAfterSelected"
                                                    forward-enter-key="forwardEnterKey" ng-disabled="disabledMode">
                                                    <div><span class="text-truncate-line ui-select-match ui-select-match"
                                                            placeholder="Nhập mã hoặc tên bệnh..."
                                                            id="itemSearchUISelectID"></span><input type="search"
                                                            autocomplete="off" autocorrect="off" autocapitalize="off"
                                                            spellcheck="false"
                                                            class="ui-select-search input-xs ng-pristine ng-untouched ng-valid"
                                                            placeholder="Nhập mã hoặc tên bệnh..."
                                                            ng-disabled="$select.disabled" ng-click="$select.activate()"
                                                            ng-model="$select.search" role="combobox" aria-expanded="false"
                                                            aria-label="Select box"
                                                            ng-class="{'spinner': $select.refreshing}"
                                                            ondrop="return false;" style="width: 10px;"></div>
                                                    <ul class="itemSelectChoices ui-select-choices ui-select-choices-content ui-select-dropdown dropdown-menu ng-hide"
                                                        ng-show="$select.open &amp;&amp; $select.items.length > 0"
                                                        refresh="fetch($select)" refresh-delay="500" repeat="item in items"
                                                        id="selectChoiceId">
                                                        <li class="ui-select-choices-group" id="ui-select-choices-46">
                                                            <div class="divider ng-hide"
                                                                ng-show="$select.isGrouped &amp;&amp; $index > 0"></div>
                                                            <div ng-show="$select.isGrouped"
                                                                class="ui-select-choices-group-label dropdown-header ng-binding ng-hide"
                                                                ng-bind="$group.name"></div>
    
                                                        </li>
                                                    </ul>
                                                    <div class="ui-select-no-choice"></div>
    
                                                </div>
                                            </div>
    
    
                                        </div>
                                        <span id="Logo" style="display:none;"></span>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr ng-show="viewModel.DoctorId > 0" class="ng-hide">
                        <td>
                            <div class="d-flex gap-10 text-left">
                                <label>Chẩn đoán của B.S</label>
                                <textarea class="form-control mb-0 ng-pristine ng-untouched ng-valid" style="width: 100%"
                                    ng-model="viewModel.DoctorComments"></textarea>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div class="d-flex gap-10 text-left">
                                <label>Diễn giải:</label>
                                <textarea class="form-control mb-0 ng-pristine ng-untouched ng-valid" style="width: 100%"
                                    ng-model="viewModel.Description"></textarea>
                            </div>
                        </td>
                    </tr>
                    <tr ng-show="enableNotifyNextPurchase &amp;&amp; viewModel.NoteTypeId==2" class="ng-hide">
                        <td>
                            <div class="d-flex gap-10 text-left">
                                <label>Ngày mua thuốc tiếp theo</label>
                                <input
                                    class="input-datetime form-control mb-0 text-box single-line ng-pristine ng-untouched ng-valid"
                                    style="text-align:left" type="text" placeholder="dd/mm/yyyy"
                                    ng-model="viewModel.NextPurchaseDate" ng-change="onNextPurchaseDateChanged()">
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
            <table class="table borderless table-condensed">
                <tbody>
                    <tr>
                        <td colspan="2">
                            <div class="d-flex justify-content-center align-items-center gap-10">
                                <input type="button" value="Quay lại" class="btn btn-default"
                                    ng-click="onReturnNotesListing(); $event.preventDefault(); $event.stopPropagation();">
                                <input type="submit" value="Ghi Phiếu - F9" id="save-note-btn-id" title="F9-Ghi phiếu"
                                    class="btn btn-primary" ng-click="saveDeliveryNote()">
    
    
                                <a class="btn btn-default ng-scope"
                                    ng-if="viewModel.TaskMode==2 &amp;&amp; deviceType==0 &amp;&amp; viewModel.NoteTypeId==4"
                                    href="#" ng-click="onPrint(0)" target="_blank">
                                    In
                                </a>
    
                                <span ng-if="viewModel.TaskMode==2" class="ng-scope">
                                    <span>&nbsp;</span>
                                    <a href="/PhieuXuats/delete/35155501" class="btn btn-danger btn btn-danger">Xóa
                                        phiếu</a>
                                    <span>&nbsp;</span>
                                    <a ng-click="onLockNote(); $event.preventDefault(); $event.stopPropagation();"
                                        title="Mở/Khóa phiếu" class="btn btn-default"><i class="fa fa-unlock fa-lg"></i></a>
                                </span>
    
    
                            </div>
                        </td>
                    </tr>
    
                    <tr ng-if="viewModel.TaskMode==2" class="ng-scope">
                        <td colspan="2" class="text-center">
                            <div class="d-flex justify-content-center align-items-center gap-10">
                                <span class="ng-binding">[Người lập: Đỗ Thanh Mai] - [Ngày lập: 16/03/2024]</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
    
        </div>
    </form>
</div>