<div>
  <div class="row">
    <div class="col-md-3">
      <form [formGroup]="formData">
        <div class="sidebar-bg">
          <fieldset class="mb-3">
            <label>Loại cơ sở</label>
            <ng-select
              appendTo="body"
              appearance="outline"
              [items]="storeTypes"
              formControlName="storeTypeId"
              bindLabel="name"
              bindValue="value"
              placeholder="Chọn loại cơ sở"
              notFoundText="Không tìm thấy mục nào"
              (change)="searchPage()"
            >
              <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                <span [ngOptionHighlight]="search">{{ item.name }}</span>
              </ng-template>
            </ng-select>
          </fieldset>
          <fieldset class="mb-3">
            <label>Tìm theo</label>
            <div class="input-group">
              <input type="text" class="form-control" formControlName="textSearch" (keyup.enter)="searchPage()"
                     placeholder="Tìm cơ sở theo mã, tên, địa chỉ...">
              <span class="input-group-btn">
                <button class="btn btn-primary" type="button" (click)="onResetSearching()"><i
                  class="fa-regular fa-arrows-rotate"></i></button>
              </span>
            </div>
          </fieldset>
          <fieldset class="mb-3 form-check">
            <input type="checkbox" formControlName="hoatDong" class="form-check-input form-control">
            <label class="form-check-label">NT đã kích hoạt</label>
          </fieldset>
          <fieldset class="mb-3">
            <label>Người tạo</label>
            <ng-select
              appendTo="body"
              appearance="outline"
              [items]="listSuperUser"
              formControlName="createdByUserId"
              bindLabel="tenDayDu"
              bindValue="id"
              placeholder="Chọn người tạo"
              notFoundText="Không tìm thấy mục nào"
            >
              <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                <span [ngOptionHighlight]="search">{{ item.tenDayDu }}</span>
              </ng-template>
            </ng-select>
          </fieldset>
          <fieldset class="mb-3">
            <label>Phân loại quầy</label>
            <ng-select
              appendTo="body"
              appearance="outline"
              [items]="storeClassifies"
              formControlName="storeClassifyId"
              bindLabel="name"
              bindValue="value"
              placeholder="Chọn phân loại quầy"
              notFoundText="Không tìm thấy mục nào"
            >
              <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                <span [ngOptionHighlight]="search">{{ item.name }}</span>
              </ng-template>
            </ng-select>
          </fieldset>
          <fieldset class="mb-3">
            <label>Trạng thái triển khai</label>
            <ng-select
              appendTo="body"
              appearance="outline"
              [items]="listTieuChiTrienKhai"
              formControlName="storeDeployTypeId"
              bindLabel="name"
              bindValue="id"
              placeholder="Chọn trạng thái triển khai"
              notFoundText="Không tìm thấy mục nào"
            >
              <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                <span [ngOptionHighlight]="search">{{ item.name }}</span>
              </ng-template>
            </ng-select>
          </fieldset>
          <fieldset class="mb-3">
            <label>Đánh giá</label>
            <ng-select
              appendTo="body"
              appearance="outline"
              [items]="storeEvaluates"
              formControlName="storeEvaluateId"
              bindLabel="name"
              bindValue="value"
              placeholder="Chọn loại đánh giá"
              notFoundText="Không tìm thấy mục nào"
            >
              <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                <span [ngOptionHighlight]="search">{{ item.name }}</span>
              </ng-template>
            </ng-select>
          </fieldset>
          <fieldset class="mb-3">
            <label>Trạng thái sử dụng Mobile App</label>
            <ng-select
              appendTo="body"
              appearance="outline"
              [items]="storeMobileAppUsedStatuses"
              formControlName="storeMobileAppUsedStatusId"
              bindLabel="name"
              bindValue="value"
              placeholder="Chọn trạng thái sử dụng Mobile App"
              notFoundText="Không tìm thấy mục nào"
            >
              <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                <span [ngOptionHighlight]="search">{{ item.name }}</span>
              </ng-template>
            </ng-select>
          </fieldset>
          <fieldset class="mb-3">
            <label>Trạng thái thanh toán</label>
            <ng-select
              appendTo="body"
              appearance="outline"
              [items]="drugStorePaymentTypes"
              formControlName="storePaymentTypeId"
              bindLabel="name"
              bindValue="value"
              placeholder="Chọn trạng thái thanh toán"
              notFoundText="Không tìm thấy mục nào"
            >
              <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                <span [ngOptionHighlight]="search">{{ item.name }}</span>
              </ng-template>
            </ng-select>
          </fieldset>
          <fieldset class="mb-3">
            <label>Chăm sóc sau bán hàng</label>
            <ng-select
              appendTo="body"
              appearance="outline"
              [items]="listSuperUser"
              formControlName="supporterId"
              bindLabel="tenDayDu"
              bindValue="id"
              placeholder="Chọn người chăm sóc sau bán hàng"
              notFoundText="Không tìm thấy mục nào"
            >
              <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                <span [ngOptionHighlight]="search">{{ item.tenDayDu }}</span>
              </ng-template>
            </ng-select>
          </fieldset>
          <fieldset class="baocao-filter">
            <label>Lọc theo khoảng thời gian giao dịch</label>
            <div>
              <div class="radio">
                <div>
                  <input type="radio" id="rdFilterAll" name="dateRangeFilterType" [checked]="filterTransactionType === 0"
                         (change)="onFilterTransactionTypeChange(0)">
                  <label for="rdFilterAll">Tất cả</label>
                </div>
                <div>
                  <input type="radio" id="rdFilterByRange" name="dateRangeFilterType" [checked]="filterTransactionType === 1"
                         (change)="onFilterTransactionTypeChange(1)">
                  <label for="rdFilterByRange">Theo ngày</label>
                </div>
                <div class="input-daterange input-group" id="datepicker" *ngIf="filterTransactionType === 1">
                  <div class="input-group">
                    <input type="text" class="form-control" placeholder="Từ ngày.." [matDatepicker]="pickerTransactionFromDate"
                           formControlName="pickerTransactionFromDate" (dateChange)="onTransactionFromDateChange($event.value)"
                           (click)="pickerTransactionFromDate.open()">
                    <mat-datepicker #pickerTransactionFromDate></mat-datepicker>
                    <span class="input-group-btn">
              <button class="btn btn-primary" (click)="pickerTransactionFromDate.open()">
                <i class="fa-regular fa-calendar-days"></i>
              </button>
            </span>
                  </div>
                  <div class="input-group">
                    <input type="text" class="form-control" placeholder="Đến ngày.." [matDatepicker]="pickerTransactionToDate"
                           formControlName="pickerTransactionToDate" (dateChange)="onTransactionToDateChange($event.value)"
                           (click)="pickerTransactionToDate.open()">
                    <mat-datepicker #pickerTransactionToDate></mat-datepicker>
                    <span class="input-group-btn">
              <button class="btn btn-primary" (click)="pickerTransactionToDate.open()">
                <i class="fa-regular fa-calendar-days"></i>
              </button>
            </span>
                  </div>
                </div>
              </div>
            </div>
          </fieldset>
          <fieldset class="baocao-filter">

            <app-date-range-filter
                                   [filterType]="0"
                                   (filterTypeChange)="changeFilterType($event)"
                                   (fromDateChange)="changeFromDate($event)"
                                   (toDateChange)="changeToDate($event)"
            ></app-date-range-filter>
            <button type="button" class="btn btn-primary w-100 mb-3" (click)="searchPage()">Xem</button>
            <div class="control-group d-flex justify-content-between gap-5 btn-group-flex mb-3">
              <button type="button" class="btn btn-primary w-50">Xuất Excel</button>
              <button type="button" class="btn btn-primary w-50" title="Xuất Excel Level cơ sở">Xuất Excel Level</button>
            </div>
            <div class="control-group d-flex justify-content-between gap-5 btn-group-flex mb-3">
              <button type="button" class="btn btn-primary w-50">Tải File</button>
              <button type="button" class="btn btn-primary w-50" title="Xuất File mẫu upload Excel">Mẫu up Excel</button>
            </div>
          </fieldset>
        </div>
      </form>
    </div>

    <div class="col-md-9">
      <div class="baocao-container box-group-white">
        <h2 class="text-center"><b>{{ getTitle() }}</b></h2>
        <div>
          <mat-form-field>
            <mat-label>Thông tin hiển thị</mat-label>
            <mat-select [formControl]="columnsControl" multiple>
              <div cdkDropList (cdkDropListDropped)="drop($event)">
                  <span *ngFor="let col of columns" cdkDrag>
                    <mat-option [value]="col.value" (click)="onChangeDisplayedColumns(col.value)" cdkDragHandle>
                      {{ col.name }}
                    </mat-option>
                  </span>
              </div>
            </mat-select>
          </mat-form-field>
          <button class="btn btn-primary" (click)="refreshColumn()">
            <i class="fa-regular fa-arrows-rotate"></i>
          </button>
        </div>
        <div class="mat-table-container">
          <table mat-table
                 class="table table-striped table-bordered table-hover tr-ng-grid"
                 [dataSource]="getDataSource()" matSort>

            <ng-container matColumnDef="#">
              <th mat-header-cell *matHeaderCellDef>#</th>
              <td mat-cell *matCellDef="let data; index as i;">
                <div class="text-center">
                  {{ (page - 1) * pageSize + i + 1 }}
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="created">
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('created')}}</th>
              <td mat-cell *matCellDef="let data">
                <div class="text-left">
                  {{ data.created | appDate }}
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="classify">
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('classify')}}</th>
              <td mat-cell *matCellDef="let data">
                <ng-select
                  appendTo="body"
                  appearance="outline"
                  [items]="storeClassifies"
                  [(ngModel)]="data.classify"
                  bindLabel="name"
                  bindValue="value"
                  placeholder="Chọn loại quầy"
                  notFoundText="Không tìm thấy mục nào"
                  (change)="onClassifyChanged($event, data)"
                >
                  <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                    <span [ngOptionHighlight]="search">{{ item.name }}</span>
                  </ng-template>
                </ng-select>
              </td>
            </ng-container>

            <ng-container matColumnDef="maNhaThuoc">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>{{getDisplayedColumnsName('maNhaThuoc')}}</th>
              <td mat-cell *matCellDef="let data">
                <div class="text-left">
                  <span [ngClass]="{'badge': data.evaluate > 0}" [style.background-color]="getBackgroundEvaluate(data.evaluate)">{{ data.maNhaThuoc }}</span>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="tenNhaThuoc">
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('tenNhaThuoc')}}</th>
              <td mat-cell *matCellDef="let data">
                <div class="text-left">
                  <span class="label label-info pull-right" title="{{data.storeHatTile}}">
                       {{ data.storeHat }}
                  </span>
                  <br/>
                  <a (click)="openAddEditDialog(data)">
                    {{ data.tenNhaThuoc }}
                  </a>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="dienThoai">
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('dienThoai')}}</th>
              <td mat-cell *matCellDef="let data">
                <div class="text-left">
                  {{ data.mobile }}
                  <br>
                  {{ data.dienThoai }}
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="connectivityCode">
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('connectivityCode')}}</th>
              <td mat-cell *matCellDef="let data"
                  [ngClass]="data.isConnectivity ? (data.isNationalDBConnected ? 'row-item-connectivity' : 'row-item-connectivity-not-connected') : ''">
                <div class="text-left">
                  <span>{{ data.connectivityCode }}</span>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="isUsedMobileApp">
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('isUsedMobileApp')}}</th>
              <td mat-cell *matCellDef="let data">
                <div class="text-left">
                  <span class="badge" [style.background-color]="data.isUsedMobileApp ? '#5cb85c' : 'rgb(194, 190, 178)'">{{ data.isUsedMobileApp ? 'Đã tải' : 'Chưa tải' }}</span>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="createdByUserName">
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('createdByUserName')}}</th>
              <td mat-cell *matCellDef="let data">
                <div class="text-left">{{ getCreatedByUserName(data.createdByUserId) }}</div>
              </td>
            </ng-container>

            <ng-container matColumnDef="thamChieuDanhMuc">
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('thamChieuDanhMuc')}}</th>
              <td mat-cell *matCellDef="let data">
                <div class="text-left">{{ data.thamChieuDanhMuc }}</div>
              </td>
            </ng-container>

            <ng-container matColumnDef="totalDrug">
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('totalDrug')}}</th>
              <td mat-cell *matCellDef="let data">
                <div class="text-left" *ngIf="formData.get('storeTypeId')?.value == 101">
                  <p>- Thuốc: {{ data.totalDrug | number }}</p>
                  <p>- Thuốc LT: {{ data.totalDrugConnectivity | number }}</p>
                </div>
                <div class="text-left" *ngIf="formData.get('storeTypeId')?.value != 101">
                  {{ data.totalDrug | number }}
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="lastTransDate"  >
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('lastTransDate')}}</th>
              <td mat-cell *matCellDef="let data">
                <div class="text-left">
                  <span *ngIf="data.lastTransDate" class="badge" [style.background-color]="getBackgroundLastTransDate(data.lastTransDate)">{{ data.lastTransDate | appDate }}</span>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="totalNote">
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('totalNote')}}</th>
              <td mat-cell *matCellDef="let data">
                <div class="text-left">{{ data.totalNote }}</div>
              </td>
            </ng-container>

            <ng-container matColumnDef="totalVisit">
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('totalVisit')}}</th>
              <td mat-cell *matCellDef="let data">
                <div class="text-left"></div>
              </td>
            </ng-container>

            <ng-container matColumnDef="isScoreRate">
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('isScoreRate')}}</th>
              <td mat-cell *matCellDef="let data">
                <div class="text-left">{{ data.isScoreRate ? 'Có' : 'Không' }}</div>
              </td>
            </ng-container>

            <ng-container matColumnDef="isAdviseStaff">
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('isAdviseStaff')}}</th>
              <td mat-cell *matCellDef="let data">
                <div class="text-left">{{ data.isAdviseStaff ? 'Có' : 'Không' }}</div>
              </td>
            </ng-container>

            <ng-container matColumnDef="totalStaff">
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('totalStaff')}}</th>
              <td mat-cell *matCellDef="let data">
                <div class="text-left">{{ data.totalStaff | number }}</div>
              </td>
            </ng-container>

            <ng-container matColumnDef="supporterId">
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('supporterId')}}</th>
              <td mat-cell *matCellDef="let data">
                <ng-select
                  appendTo="body"
                  appearance="outline"
                  [items]="listSuperUser"
                  [(ngModel)]="data.supporterId"
                  bindLabel="tenDayDu"
                  bindValue="id"
                  placeholder="Chọn nhân viên"
                  notFoundText="Không tìm thấy mục nào"
                  (change)="onSupporterChanged($event, data)"
                >
                  <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                    <span [ngOptionHighlight]="search">{{ item.tenDayDu }}</span>
                  </ng-template>
                </ng-select>
              </td>
            </ng-container>

            <ng-container matColumnDef="resultBusinessId">
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('resultBusinessId')}}</th>
              <td mat-cell *matCellDef="let data">
                <ng-select
                  appendTo="body"
                  appearance="outline"
                  [items]="listTieuChiTrienKhai"
                  [(ngModel)]="data.resultBusinessId"
                  bindLabel="name"
                  bindValue="id"
                  placeholder="Chưa triển khai"
                  notFoundText="Không tìm thấy mục nào"
                  (change)="onResultBusinessChanged($event, data)"
                >
                  <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                    <span [ngOptionHighlight]="search">{{ item.name }}</span>
                  </ng-template>
                </ng-select>
              </td>
            </ng-container>

            <ng-container matColumnDef="businessDescription">
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('businessDescription')}}</th>
              <td mat-cell *matCellDef="let data">
                <div style="width: 150px">
                  <div *ngIf="!data.isEditBusinessDescription">
                    {{ data.businessDescription }}
                    <a class="btn btn-sm btn-primary" title="Cập nhật thông tin"
                       (click)="data.isEditBusinessDescription = true;"><i
                      class="fa-regular fa-pen"></i></a>
                  </div>
                  <div *ngIf="data.isEditBusinessDescription">
                    <textarea type="text" [(ngModel)]="data.businessDescription" class="form-control mb-2">
                    </textarea>
                    <input type="button" value="Lưu" class="btn btn-sm btn-primary w-100"
                           (click)="onUpdateBusinessDescription(data)">
                  </div>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="level">
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('level')}}</th>
              <td mat-cell *matCellDef="let data">
                <div class="text-right">{{ data.level | number }}</div>
              </td>
            </ng-container>

            <ng-container matColumnDef="evaluate">
              <th mat-header-cell *matHeaderCellDef>{{getDisplayedColumnsName('evaluate')}}</th>
              <td mat-cell *matCellDef="let data">
                <div class="text-right">
                  <ng-select
                    appendTo="body"
                    appearance="outline"
                    [items]="storeEvaluates"
                    [(ngModel)]="data.evaluate"
                    bindLabel="name"
                    bindValue="value"
                    placeholder="Chọn loại đánh giá"
                    notFoundText="Không tìm thấy mục nào"
                    (change)="onEvaluateChanged($event, data)"
                  >
                    <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                      <span [ngOptionHighlight]="search">{{ item.name }}</span>
                    </ng-template>
                  </ng-select>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="footer">
              <td mat-footer-cell *matFooterCellDef colspan="100">
                <app-pagination [currentPage]="page" [totalPages]="totalPages" [totalRecord]="totalRecord"
                                (pageChange)="changePageIndex($event)"
                                (pageSizeChange)="changePageSize($event)"></app-pagination>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="getDisplayedColumns(); sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: getDisplayedColumns();"></tr>
            <tr mat-footer-row *matFooterRowDef="['footer']; sticky: true"></tr>

          </table>
        </div>
      </div>
    </div>
  </div>
</div>
